<!DOCTYPE html>

<html lang="en">
<!-- THEME BOOT: put before CSS to avoid FOUC -->
<script>
(function(){
  try{
    var ls = localStorage.getItem('sb_theme');
    if(ls){
      var t = JSON.parse(ls);
      var c = t.brand || t.color;
      if(c){
        var r = document.documentElement;
        r.style.setProperty('--sb-accent', c);
        r.style.setProperty('--sb-primary', c);
      }
    }
  }catch(e){}
})();
</script>
<meta charset="utf-8"/>
<title>Deal Detail</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="style.css" rel="stylesheet"/>
<link href="global.css" rel="stylesheet"/>
<link href="header.css" rel="stylesheet">
<style>
    /* Minimal polish */
    
    #report-abuse-btn {
      background: #ffe8e8;
    }
    #report-abuse-btn.disabled {
      opacity: 0.6; cursor: not-allowed;
    }
    .safety-section {
      margin-top: 0.75rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .muted {
      color: #666; font-size: 0.9rem;
    }

    /* --- Enhanced Deal Detail Styles --- */
    /* Container for detail page card */
    .deal-detail-card {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    body.dark .deal-detail-card {
      background: #1e1e1e;
      color: #ddd;
    }
    .deal-detail-card h3, .deal-detail-card h1 {
      font-size: 1.8rem;
      color: #e91e63;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 0 0 0.5rem;
    }
    .deal-detail-card .bookmark-icon {
      font-size: 1.5rem;
      margin-left: 8px;
      cursor: pointer;
    }
    .deal-detail-card .deal-summary {
      font-style: italic;
      color: #666;
      margin: 0.5rem 0 1rem;
    }
    .deal-detail-card .deal-media {
      text-align: center;
      margin-bottom: 1rem;
    }
    .deal-detail-card .deal-media img {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .deal-detail-card #deal-description {
      margin-top: 1rem;
      line-height: 1.6;
      font-size: 1rem;
    }
    .deal-detail-card .tags {
      margin-top: 0.5rem;
    }
    .deal-detail-card .user-info {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 0.75rem;
      font-weight: 500;
    }
    .deal-detail-card #business-profile {
      margin-top: 0.5rem;
    }
    .deal-detail-card .views-info {
      margin-top: 0.5rem;
      color: #555;
    }
    .deal-detail-card .deal-actions {
      margin-top: 1.5rem;
      border-top: 1px solid #eee;
      padding-top: 1rem;
    }
    .deal-detail-card .vote-section,
    .deal-detail-card 
    .deal-detail-card button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .deal-detail-card .vote-section button[data-vote="up"] {
      background: #e8f5e9;
    }
    .deal-detail-card .vote-section button[data-vote="down"] {
      background: #ffebee;
    }
    .deal-detail-card .feedback-section button[data-feedback="useful"] {
      background: #e8f5e9;
    }
    .deal-detail-card .feedback-section button[data-feedback="not_interested"] {
      background: #fff8e1;
    }
    .deal-detail-card .feedback-section button[data-feedback="fake"] {
      background: #ffebee;
    }
    .deal-detail-card #report-abuse-btn {
      background: #fff5f5;
    }
    .deal-detail-card #report-abuse-btn.disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    /* Remove pointer cursor on detail page */
    .deal-detail-card, .deal-detail-card * {
      cursor: default !important;
    }
  
/* Minimal actions strip (low emphasis) */
.deal-actions{display:flex;align-items:center;gap:12px;margin-top:10px;font-size:13px;color:#6b7280}
.deal-actions .action{display:inline-flex;align-items:center;gap:6px;padding:4px 6px;background:transparent;border:0;border-radius:8px;cursor:pointer;color:inherit}
.deal-actions .action:hover{background:#f5f5f5;color:#374151}
.deal-actions .action:disabled{opacity:.6;cursor:default}
.deal-actions .ic{display:block;opacity:.75}
.deal-actions .count{font-weight:600;font-size:12px;opacity:.85}
.deal-actions .is-muted .ic{opacity:.55}
.report-link{padding:0;background:none;border:0;color:#9ca3af;text-decoration:underline;text-underline-offset:3px;cursor:pointer}
.report-link:hover{color:#ef4444}
@media(max-width:768px){.deal-actions{gap:14px;font-size:14px}}


/* Two-column layout for deal page */
.deal-grid{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:24px;align-items:start;margin-top:8px}
.deal-left img{width:100%;height:auto;border-radius:12px}
.deal-right-col{display:block}
@media(max-width:1024px){.deal-grid{grid-template-columns:1fr}}

/* Meta + badges */
.role-badge{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;margin-left:6px}
.role-badge .ic{width:12px;height:12px}
.is-verified{background:#e0e7ff;color:#3730a3}
.is-biz{background:#fef3c7;color:#b45309}
.ic-user{margin-right:6px;opacity:.75}
.deal-meta{display:flex;align-items:center;gap:6px}

/* Comments preview */
.comments-preview{margin-top:12px}
.cp-title{font-size:13px;font-weight:600;color:#374151;margin-bottom:6px}
.comment-snippet{font-size:13px;color:#4b5563;padding:6px 0;border-bottom:1px solid #f1f5f9}
.comment-snippet .author{font-weight:600;margin-right:6px;color:#374151}
.cp-link{display:inline-block;margin-top:6px;font-size:13px;color:#6b7280;text-decoration:underline;text-underline-offset:3px}
.cp-link:hover{color:#111827}


/* Two-column layout */
.deal-grid{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:24px;align-items:start;margin-top:8px}
.deal-left .deal-media{width:100%}
.deal-right-col{display:block}
@media(max-width:1024px){.deal-grid{grid-template-columns:1fr}}

</style>
<link href="deal.css" rel="stylesheet"/>
<style>
.deal-layout.two-col{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:24px;align-items:start}
@media(max-width:1024px){.deal-layout.two-col{grid-template-columns:1fr}}
</style>

<body>
<!-- Global Header mount -->
<div id="global-header"></div>
<!-- Global Header --><script defer="" src="loadHeader.js"></script>
<main class="deal-layout two-col">
<section class="deal-left">
<div class="deal-media" id="deal-media"></div>
</section>
<section class="deal-right">
<h1 class="deal-title-row">
<span id="deal-title">Loading...</span>
<span class="bookmark-icon" id="bookmark-container" title="Bookmark">‚òÖ</span>
</h1>
<p class="deal-summary" id="deal-summary"></p>
<div id="deal-description"></div>
<div class="tags" id="deal-tags"></div>
<div id="deal-status"></div>
<div class="meta-row" id="deal-meta">
<span class="user-info"><span class="user-icon" id="user-icon"></span> <span id="deal-user">Loading...</span></span>
<span class="chip" id="verified-badge"></span>
<span class="chip chip-blue" id="business-badge"></span>
<span class="chip chip-muted" id="views-chip">üëÅÔ∏è <span id="views-count">0</span> views</span>
</div>
<div class="deal-actions" id="deal-actions">
<button aria-label="Upvote" class="action vote-btn" data-vote="up">
<svg aria-hidden="true" class="ic" height="16" viewbox="0 0 24 24" width="16"><path d="M2 10h4v10H2zM8 21h7.2a3 3 0 0 0 2.94-2.46l1.18-7A3 3 0 0 0 16.37 8H13V5a3 3 0 0 0-3-3l-2 6v13z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="1.6"></path></svg>
<span class="count" id="vote-count">0</span>
</button>
<button aria-label="Downvote" class="action vote-btn" data-vote="down">
<svg aria-hidden="true" class="ic" height="16" viewbox="0 0 24 24" width="16"><path d="M22 14h-4V4h4zM16 3H8.8A3 3 0 0 0 5.86 5.46l-1.18 7A3 3 0 0 0 7.63 16H11v3a3 3 0 0 0 3 3l2-6V3z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="1.6"></path></svg>
<span class="count" id="downvote-count">0</span>
</button>
<button aria-label="Reports" class="action is-muted" disabled="" id="btn-reports">
<svg aria-hidden="true" class="ic" height="16" viewbox="0 0 24 24" width="16"><path d="M6 21V4h9l1 3h3v7h-7l-1-3H6z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="1.6"></path></svg>
<span class="count" id="report-count">0</span>
</button>
<button aria-label="Report" class="report-link" id="report-abuse-btn">Report</button><span aria-live="polite" class="report-status" id="report-status"></span>
</div>
<div class="comments-preview">
<div class="cp-title">Recent comments</div>
<div id="comment-preview"></div>
<a class="cp-link" href="#comments-section" id="comments-link">View all comments</a>
</div>
</section>
</main>
<section style="margin-top: 2rem;">
<h3>üí¨ Comments</h3>
<div id="comments-list" style="margin-bottom: 1rem;"></div>
<div id="comment-form-container" style="display:none;">
<textarea id="comment-text" placeholder="Write your comment..." style="width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;"></textarea><br/>
<button id="submit-comment" style="margin-top:8px;padding:8px 15px;background:#28a745;color:#fff;border:none;border-radius:5px;">Post Comment</button>
</div>
</section>


<div class="deal-sticky" id="sticky-bar">
<button class="sticky-cta" id="sticky-cta">View Deal</button>
<div class="sticky-actions">
<button class="vote-btn" data-vote="up">üëç</button>
<button class="feedback-btn" data-feedback="fake">üö©</button>
</div>
</div>
<!-- Deal Logic -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const username = localStorage.getItem("username");
  const dealId = new URLSearchParams(window.location.search).get("id");

  // Guard: missing deal id
  if (!dealId) {
    document.getElementById("deal-title").textContent = "Deal not found.";
    return;
  }

  // Detailed deal loading is handled in deal.js. Only comments and abuse reporting are managed here.

  // Load comments with reaction counts
  function renderComments() {
    fetch("api/get_comments.php?id=" + encodeURIComponent(dealId))
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("comments-list");
        container.innerHTML = "";
        if (data.success && Array.isArray(data.comments) && data.comments.length > 0) {
          data.comments.forEach(c => {
            const wrapper = document.createElement("div");
            wrapper.className = "comment-item";
            const user = c.username || "User";
            const commentText = c.comment || "";
            wrapper.innerHTML = `<strong>${user}</strong>: ${commentText}`;
            /* comment reactions removed */
container.appendChild(wrapper);
          });
          // Attach click handlers for reactions
          container.querySelectorAll('.comment-like-btn, .comment-dislike-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const reactionType = btn.dataset.reaction;
              const commentId = btn.dataset.id;
              const currentUser = localStorage.getItem('username');
              if (!currentUser) {
                alert('Please log in to react to comments.');
                return;
              }
              fetch('api/reactions.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment_id: commentId, username: currentUser, type: reactionType })
              })
                .then(res => res.json())
                .then(resp => {
                  if (resp && resp.success) {
                    // Update counts in UI
                    const parent = btn.parentElement;
                    if (parent) {
                      const likesLabel = parent.querySelector('.likes-count');
                      const dislikesLabel = parent.querySelector('.dislikes-count');
                      if (likesLabel) likesLabel.textContent = resp.likes;
                      if (dislikesLabel) dislikesLabel.textContent = resp.dislikes;
                    }
                  } else {
                    alert((resp && resp.error) || 'Failed to react');
                  }
                })
                .catch(() => alert('Error sending reaction'));
            });
          });
        } else {
          container.textContent = "No comments yet.";
        }
      })
      .catch(() => {
        const container = document.getElementById("comments-list");
        container.textContent = "Failed to load comments";
      });
  }
  renderComments();

  // Show comment form if logged in and not muted; otherwise hide and show message
  const commentFormContainer = document.getElementById("comment-form-container");
  const isLoggedIn = !!localStorage.getItem('username');
  const isMutedUser = localStorage.getItem('is_muted') === '1';
  if (isLoggedIn && !isMutedUser) {
    if (commentFormContainer) commentFormContainer.style.display = 'block';
    const submitBtn = document.getElementById('submit-comment');
    if (submitBtn) {
      submitBtn.addEventListener('click', () => {
        const commentText = (document.getElementById('comment-text').value || '').trim();
        if (!commentText) {
          alert('Comment cannot be empty.');
          return;
        }
        const currentUser = localStorage.getItem('username');
        fetch('api/post_comment.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: currentUser, deal_id: dealId, comment: commentText })
        })
          .then(res => res.json())
          .then(resp => {
            if (resp && resp.success) {
              // Refresh comments without reloading the entire page
              document.getElementById('comment-text').value = '';
              renderComments();
            } else {
              alert((resp && resp.error) || 'Failed to post comment.');
            }
          })
          .catch(() => alert('Failed to post comment.'));
      });
    }
  } else {
    // Not logged in or muted
    if (commentFormContainer) commentFormContainer.style.display = 'none';
    const msg = document.createElement('p');
    msg.className = 'muted';
    msg.textContent = isMutedUser ? 'You are muted and cannot post comments.' : 'Please log in to post a comment.';
    const section = commentFormContainer ? commentFormContainer.parentElement : document.querySelector('section');
    if (section) section.appendChild(msg);
  }

  // üö© Report Abuse logic
  const reportBtn = document.getElementById("report-abuse-btn");
  const reportStatus = document.getElementById("report-status");
  function setReportStatus(msg){ if (reportStatus) reportStatus.textContent = msg; }
  let reporting = false;
// Client rate limit: prevent repeat reports within 2 minutes per user per deal
const RL_WINDOW_MS = 2 * 60 * 1000;
function canReportNow(dealId, user){
  try{
    const key = 'report_rl:'+user+':'+dealId;
    const last = parseInt(localStorage.getItem(key)||'0',10)||0;
    const now = Date.now();
    return (now - last) >= RL_WINDOW_MS;
  }catch(e){ return true; }
}

function markReportWindow(dealId, user){
  try{
    const key = 'report_rl:'+user+':'+dealId;
    localStorage.setItem(key, String(Date.now()));
  }catch(e){}
}


  if (reportBtn) {
    reportBtn.addEventListener("click", () => {
      if (reporting) return;
      const currentUser = localStorage.getItem("username");

      if (!currentUser) {
        alert("Please log in to report abuse.");
        return;
      }

      if (!canReportNow(dealId, currentUser)) { alert('Please wait before submitting another report for this deal.'); return; }
      const reason = prompt("Enter reason for reporting this deal (e.g., spam, scam, inappropriate):");
      if (!reason || !reason.trim()) return;
      reporting = true;
      reportBtn.classList.add("disabled");
      setReportStatus("Submitting report...");
      // Use form-encoded data to support PHP $_POST parsing
      const formData = new URLSearchParams();
      formData.append('deal_id', dealId);
      formData.append('username', currentUser);
      formData.append('reason', reason.trim());
      fetch("api/report_abuse.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-Requested-With": "XMLHttpRequest"
          },
          body: (function(){
            const form = new URLSearchParams();
            const userId = localStorage.getItem("user_id") || localStorage.getItem("userid") || "";
            form.set("deal_id", dealId);
            form.set("dealId", dealId);
            form.set("reason", reason.trim());
            form.set("reason_text", reason.trim());
            form.set("username", currentUser || "");
            form.set("user_id", userId);
            form.set("action", "report");
            form.set("source", "deal_page");
            return form.toString();
          })(),
          credentials: "same-origin"
        })
        .then(async (res) => {
          const text = await res.text();
          let data;
          try { data = JSON.parse(text); } catch { data = null; }
          const ok = data && (data.ok === true || data.success === true || data.status === "ok");
          if (res.ok && ok) {
            markReportWindow(dealId, currentUser);
            alert("Report submitted.");
            setReportStatus("Thank you. Our team will review this report.");
          } else {
            const err = (data && (data.error || data.message)) || text || "Unknown error";
            console.error("report_abuse.php error:", err);
            alert(err.length > 200 ? "Failed to submit report." : err);
            setReportStatus("Failed to submit report.");
          }
        })
        .catch(() => {
          alert("Network error. Please try again later.");
          setReportStatus("Failed to submit report.");
        })
        .finally(() => {
          reporting = false;
          reportBtn.classList.remove("disabled");
        });
    });
  }
});
</script>
<!-- Other Deal Logic (votes/bookmarks/feedbacks) -->
<script src="deal.js?v=2025-08-11-04"></script>
<script src="footer.js"></script>
<script>
// mirror sticky CTA from #deal-cta (added by deal.js)
(function(){
  const target = document.getElementById('deal-cta');
  if (!target) return;
  const mo = new MutationObserver(() => {
    const a = target.querySelector('a');
    if (a) {
      const sticky = document.getElementById('sticky-cta');
      if (sticky) {
        sticky.textContent = a.textContent || 'View Deal';
        sticky.onclick = () => window.open(a.href, '_blank');
      }
      mo.disconnect();
    }
  });
  mo.observe(target, { childList: true });
})();
</script>
<script>
(function(){
  function byId(id){ return document.getElementById(id); }
  const title = byId('deal-title');
  const meta  = byId('deal-meta');
  const actions = document.getElementById('deal-actions');
  const slotT = byId('deal-title-slot');
  const slotM = byId('deal-meta-slot');
  const slotA = byId('deal-actions-slot');
  if (title && slotT) slotT.appendChild(title);
  if (meta && slotM) slotM.appendChild(meta);
  if (actions && slotA) slotA.appendChild(actions);

  window.renderCommentPreview = function(list){
    const wrap = byId('comment-preview');
    const link = byId('comments-link');
    if (!wrap) return;
    wrap.innerHTML = '';
    const items = (list||[]).slice(0,2);
    if (items.length === 0){
      wrap.innerHTML = '<div class="comment-snippet" style="opacity:.7">No comments yet.</div>';
    }else{
      items.forEach(c => {
        const div = document.createElement('div');
        div.className = 'comment-snippet';
        const author = (c.username || c.user || 'user');
        const text = (c.text || c.comment || '').toString();
        div.innerHTML = '<span class="author">'+escapeHtml(author)+'</span><span class="text">'+escapeHtml(text)+'</span>';
        wrap.appendChild(div);
      });
    }
    if (link){ link.textContent = 'View all comments ('+(list?list.length:0)+')'; }
  };
  function escapeHtml(s){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
})();
</script>
</body>
</link></html>

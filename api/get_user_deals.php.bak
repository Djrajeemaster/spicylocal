<?php
require_once __DIR__ . '/config/db.php';

header('Content-Type: application/json');

$username = $_GET['username'] ?? '';
$status = $_GET['status'] ?? 'all';

$response = ['success' => false, 'deals' => []];

if ($username) {
    /*
     * Retrieve a user's deals with additional metadata: username,
     * verification flags, tags and a thumbnail. The GROUP BY and
     * GROUP_CONCAT operate similarly to those in get_deals.php.
     */
    $sql = "SELECT deals.*, users.username, users.is_verified, users.is_verified_business,
                   GROUP_CONCAT(DISTINCT dt.tag_name) AS tags,
                   MIN(di.image_path) AS thumbnail
            FROM deals
            JOIN users ON deals.user_id = users.id
            LEFT JOIN deal_tags dt ON deals.id = dt.deal_id
            LEFT JOIN deal_images di ON deals.id = di.deal_id
            WHERE users.username = ?";
    $params = [$username];

    if ($status !== 'all') {
        $sql .= " AND deals.status = ?";
        $params[] = $status;
    }

    $sql .= " GROUP BY deals.id";
    $stmt = $pdo->prepare($sql);
    $stmt->execute($params);
    $deals = $stmt->fetchAll(PDO::FETCH_ASSOC);

    // Assign default empty array for tags if null
    foreach ($deals as &$d) {
        $d['tags'] = $d['tags'] ? array_filter(array_map('trim', explode(',', $d['tags']))) : [];
    }
    $response['success'] = true;
    $response['deals'] = $deals;
}

echo json_encode($response);
?>
